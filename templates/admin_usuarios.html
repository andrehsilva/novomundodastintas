{% extends 'base.html' %}
{% block title %}Gestão de Usuários - PinturaFiel{% endblock %}

{% block content %}
<style>
    .dt-search input { @apply input input-bordered input-sm bg-white text-gray-700 !important; border-color: #d1d5db !important; }
    .dt-paging-button { @apply btn btn-sm btn-ghost !important; background-color: white !important; color: #00295d !important; border: 1px solid #e5e7eb !important; }
    .dt-paging-button.current { @apply btn-primary text-white !important; border: none !important; }
    .buttons-excel { @apply btn btn-success btn-sm text-white border-none shadow-sm !important; background-color: #22c55e !important; }
    .dt-container { @apply text-base-content !important; }
    .dt-info { @apply text-xs opacity-70 !important; }
</style>

<div class="max-w-[98%] mx-auto space-y-6 pb-10">
    
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-base-100 p-6 rounded-2xl shadow-sm border border-base-300">
        <div>
            <h1 class="text-3xl font-bold text-[#00295d]">Gestão de Usuários</h1>
            <p class="text-sm opacity-60">Controle de perfis, ativações e auditoria de pontos.</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <button onclick="modal_credito.showModal()" class="btn btn-primary text-white shadow-md">
                <i class="fa-solid fa-plus-circle mr-2"></i> Novo Lançamento de Pontos
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <div class="card bg-white shadow-lg border-l-4 border-l-warning">
            <div class="card-body p-4">
                <h2 class="card-title text-sm text-warning flex items-center gap-2">
                    <i class="fa-solid fa-user-clock"></i> Solicitações de Cadastro ({{ pintores | selectattr('ativo', 'equalto', false) | list | length }})
                </h2>
                <div class="overflow-x-auto mt-2">
                    <table class="table table-xs w-full">
                        <tbody>
                            {% for u in pintores if not u.ativo %}
                            <tr class="hover:bg-base-200/50">
                                <td class="font-bold">{{ u.nome }}</td>
                                <td class="text-xs">{{ u.email }}</td>
                                <td class="text-right">
                                    <form method="post" action="{{ url_for('ativar_usuario', id=u.id) }}">
                                        <button class="btn btn-warning btn-xs text-white">Ativar Acesso</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center py-4 opacity-40 text-xs italic">Nenhum cadastro pendente.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% set pendentes = transacoes_todas | selectattr('status', 'equalto', 'pendente') | list %}
        <div class="card bg-white shadow-lg border-l-4 border-l-info">
            <div class="card-body p-4">
                <h2 class="card-title text-sm text-info flex items-center gap-2">
                    <i class="fa-solid fa-hand-holding-dollar"></i> Resgates para Aprovar ({{ pendentes | length }})
                </h2>
                <div class="overflow-x-auto mt-2">
                    <table class="table table-xs w-full">
                        <tbody>
                            {% for r in pendentes %}
                            <tr class="hover:bg-base-200/50">
                                <td class="font-bold">{{ r.user_obj.nome }}</td>
                                <td class="italic text-xs">{{ r.descricao }}</td>
                                <td class="text-right space-x-1">
                                    <form method="post" action="{{ url_for('admin_aprovar_resgate', id=r.id, acao='confirmar') }}" class="inline">
                                        <button class="btn btn-success btn-xs text-white">Aprovar</button>
                                    </form>
                                    <form method="post" action="{{ url_for('admin_aprovar_resgate', id=r.id, acao='reprovar') }}" class="inline">
                                        <button class="btn btn-ghost btn-xs text-error">Recusar</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center py-4 opacity-40 text-xs italic">Nenhum pedido de resgate.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-white shadow-xl border border-base-300">
        <div class="card-body p-6">
            <h2 class="font-bold text-[#00295d] mb-4 flex items-center gap-2">
                <i class="fa-solid fa-users"></i> Profissionais Ativos no Sistema
            </h2>
            <table id="tabelaPintores" class="table table-zebra w-full !border-collapse">
                <thead class="bg-base-200 text-[#00295d]">
                    <tr>
                        <th>Pintor</th>
                        <th>CPF/CNPJ</th>
                        <th>E-mail</th>
                        <th>Saldo Atual</th>
                        <th class="text-center no-export">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in pintores if p.ativo %}
                    <tr>
                        <td class="font-bold">{{ p.nome }}</td>
                        <td class="text-xs">{{ p.cpf_cnpj }}</td>
                        <td class="text-xs">{{ p.email }}</td>
                        <td>
                            <div class="badge badge-neutral font-bold">{{ p.saldo_total }} pts</div>
                        </td>
                        <td class="text-center">
                            <div class="flex justify-center gap-1">
                                <button onclick="document.getElementById('modal_log_{{ p.id }}').showModal()" class="btn btn-circle btn-ghost btn-xs text-info" title="Histórico">
                                    <i class="fa-solid fa-clock-rotate-left"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <dialog id="modal_credito" class="modal">
        <div class="modal-box max-w-md border-t-4 border-primary">
            <h3 class="font-bold text-xl mb-6 text-[#00295d] flex items-center gap-2">
                <i class="fa-solid fa-coins text-primary"></i> Crédito de Pontos
            </h3>
            <form method="post" action="{{ url_for('admin_usuarios') }}" class="space-y-4">
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Pintor</span></label>
                    <select name="user_id" class="select select-bordered w-full" required>
                        <option value="" disabled selected>Selecione o profissional...</option>
                        {% for p in pintores if p.ativo %}
                        <option value="{{ p.id }}">{{ p.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Quantidade de Pontos</span></label>
                    <input type="number" name="pontos" class="input input-bordered w-full" placeholder="Ex: 500" required min="1">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Referência (NF ou Motivo)</span></label>
                    <input type="text" name="descricao" class="input input-bordered w-full" placeholder="Ex: NF 12345" required>
                </div>
                <button type="submit" class="btn btn-primary w-full text-white font-bold">Confirmar Lançamento</button>
            </form>
            <form method="dialog" class="mt-2"><button class="btn btn-ghost btn-block btn-sm">Cancelar</button></form>
        </div>
        <form method="dialog" class="modal-backdrop bg-black/50"><button>close</button></form>
    </dialog>

    {% for p in pintores %}
    <dialog id="modal_log_{{ p.id }}" class="modal">
        <div class="modal-box w-11/12 max-w-4xl p-0 overflow-hidden">
            <div class="bg-base-200 p-6 flex justify-between items-center border-b border-base-300">
                <h3 class="font-bold text-xl text-[#00295d]">Extrato: {{ p.nome }}</h3>
                <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost">✕</button></form>
            </div>
            <div class="p-6">
                <table class="table table-sm w-full tabelaModal">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Status</th>
                            <th class="text-right">Pontos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in p.transacoes | sort(attribute='data', reverse=True) %}
                        <tr>
                            <td>{{ t.data.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ t.descricao }}</td>
                            <td>
                                <span class="badge badge-xs p-2 font-bold 
                                    {{ 'badge-success' if t.status == 'entregue' or t.status == 'concluido' }}
                                    {{ 'badge-warning' if t.status == 'pendente' }}
                                    {{ 'badge-error' if t.status == 'reprovado' }}">
                                    {{ t.status | upper }}
                                </span>
                            </td>
                            <td class="text-right font-bold {{ 'text-success' if t.pontos > 0 else 'text-error' }}">
                                {{ t.pontos }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </dialog>
    {% endfor %}

</div>

<script>
$(document).ready(function() {
    // Configuração do DataTables para a lista de pintores
    $('#tabelaPintores').DataTable({
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' },
        pageLength: 10,
        dom: '<"flex justify-between items-center mb-4"B f>rt<"flex justify-between items-center mt-4"i p>',
        buttons: [{
            extend: 'excelHtml5',
            text: '<i class="fa-solid fa-file-excel mr-2"></i> Relatório de Auditoria (Excel)',
            className: 'btn btn-success btn-sm text-white',
            title: 'PinturaFiel_Saldo_Usuarios',
            exportOptions: { columns: ':not(.no-export)' }
        }]
    });

    // Configuração simples para os históricos dentro dos modais
    $('.tabelaModal').DataTable({
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' },
        pageLength: 5,
        dom: 'frtip'
    });
});
</script>
{% endblock %}